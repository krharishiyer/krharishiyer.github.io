<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Event Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background-color: black;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .title {
      font-size: 0.5em;
      flex: 1;
      text-align: left;
    }

    .summary {
      font-size: 0.5em;
      flex: 1;
      text-align: center;
    }

    .file-label {
      background-color: #222;
      color: white;
      padding: 6px 10px;
      border: 1px solid #555;
      border-radius: 6px;
      font-size: 0.5em;
      cursor: pointer;
      flex: 1;
      text-align: right;
    }

    .file-label:active {
      background-color: #444;
    }

    #dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      flex-grow: 1;
      align-content: start;
    }

    .event {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px;
      background-color: #111;
      border: 1px solid #333;
      border-radius: 6px;
      font-size: 0.5em;
      white-space: nowrap;
    }

    .label {
      display: flex;
      align-items: center;
    }

    .led {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 10px;
      background-color: transparent;
      flex-shrink: 0;
    }

    .led.blink {
      background-color: red;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    .tick {
      cursor: pointer;
      font-size: 0.5em;
      color: white;
      transition: color 0.3s;
    }

    .tick.done {
      color: limegreen;
    }

    #confetti {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 999;
      overflow: hidden;
      display: none;
    }

    .confetti-piece {
      position: absolute;
      width: 8px;
      height: 8px;
      background-color: red;
      animation: fall 2s linear infinite;
    }

    @keyframes fall {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">üóìÔ∏è Event Dashboard ‚Äì <span id="today"></span></div>
    <div class="summary" id="summaryBanner">Loading summary...</div>
    <label for="fileInput" class="file-label">üìÇ Choose File</label>
    <input type="file" id="fileInput" accept=".txt" style="display:none;">
  </div>

  <div id="dashboard"></div>
  <div id="confetti"></div>

  <script>
    const today = new Date();
    const todayKey = today.toISOString().split("T")[0];
    document.getElementById("today").textContent = today.toDateString();

    const tickState = JSON.parse(localStorage.getItem("tickState") || "{}");
    const savedEvents = JSON.parse(localStorage.getItem("eventData") || "[]");

    function isEventToday(event) {
      const nextDate = getNextOccurrence(event);
      return nextDate.toDateString() === today.toDateString();
    }

    function getNextOccurrence(event) {
      const unit = event.unit;
      const interval = event.interval;
      const startDate = new Date(event.startDate);
      const base = new Date(today);

      if (unit === "day") {
        const msPerDay = 1000 * 60 * 60 * 24;
        const diffDays = Math.floor((base - startDate) / msPerDay);
        const offset = (interval - (diffDays % interval)) % interval;
        base.setDate(base.getDate() + offset);
        return base;
      }

      if (unit === "month") {
        const startDay = startDate.getDate();
        const monthsSinceStart = (base.getFullYear() - startDate.getFullYear()) * 12 + (base.getMonth() - startDate.getMonth());
        const offset = (interval - (monthsSinceStart % interval)) % interval;
        const nextMonth = base.getMonth() + offset;
        return new Date(base.getFullYear(), nextMonth, startDay);
      }

      if (unit === "year") {
        const startDay = startDate.getDate();
        const startMonth = startDate.getMonth();
        const yearsSinceStart = base.getFullYear() - startDate.getFullYear();
        const offset = (interval - (yearsSinceStart % interval)) % interval;
        const nextYear = base.getFullYear() + offset;
        return new Date(nextYear, startMonth, startDay);
      }
    }

    function renderDashboard(events) {
      const dashboard = document.getElementById("dashboard");
      const summaryBanner = document.getElementById("summaryBanner");
      dashboard.innerHTML = "";

      let totalToday = 0;
      let completedToday = 0;

      events.forEach(event => {
        const eventId = `${todayKey}_${event.name}`;
        const isDone = tickState[eventId] === true;
        const isDueToday = isEventToday(event);

        if (isDueToday) {
          totalToday++;
          if (isDone) completedToday++;
        }

        const ledClass = (!isDone && isDueToday) ? "led blink" : "led";
        const tickClass = isDone ? "tick done" : "tick";

        const div = document.createElement("div");
        div.className = "event";

        const label = document.createElement("div");
        label.className = "label";
        label.innerHTML = `<div class="${ledClass}"></div>${event.name}`;

        const tick = document.createElement("div");
        tick.className = tickClass;
        tick.innerHTML = "‚úî";
        tick.title = "Mark as done";

        tick.addEventListener("click", () => {
          tickState[eventId] = !tickState[eventId];
          localStorage.setItem("tickState", JSON.stringify(tickState));
          renderDashboard(events);
        });

        div.appendChild(label);
        div.appendChild(tick);
        dashboard.appendChild(div);
      });

      summaryBanner.textContent = `üßæ ${totalToday} events today, ${completedToday} completed`;

      if (totalToday > 0 && completedToday === totalToday) {
        triggerConfetti();
      } else {
        stopConfetti();
      }
    }

    function triggerConfetti() {
      const confetti = document.getElementById("confetti");
      confetti.innerHTML = "";
      confetti.style.display = "block";

      for (let i = 0; i < 100; i++) {
        const piece = document.createElement("div");
        piece.className = "confetti-piece";
        piece.style.left = Math.random() * 100 + "vw";
        piece.style.top = "-10px";
        piece.style.backgroundColor = getRandomColor();
        piece.style.animationDuration = 1 + Math.random() * 2 + "s";
        confetti.appendChild(piece);
     